import{r,a as J,q as K,c as X,d as Z,j as t,F as ee,e as te,I as c,D as m,C as x,a2 as se,a0 as ae,v as re,S as n,a5 as A,a1 as g,a6 as oe,w as ne}from"./index-BlaCQYdb.js";import{r as le,u as ie}from"./xlsx-uZelXSz_.js";import{R as P}from"./RadioButtonGroup-Dg51B77y.js";import{u as ce}from"./useCourseParam-Cp9FvxYK.js";const fe=({onClose:f,onTestAdded:M})=>{const b=r.useRef(null),y=r.useRef(),R=J(),[j,N]=r.useState(""),[w,d]=r.useState([]),[C,u]=r.useState(!1),[F,$]=r.useState([]),[de,E]=r.useState([]),[pe,I]=r.useState([]),[_,T]=r.useState([]),{rolePermissions:q}=K(e=>e.permissions),L={title:"",testLevel:"Beginner",courseId:"",phaseId:"",weekId:"",chapterId:"",batchId:"",totalMarks:"",passingMarks:"",minutes:"",seconds:"0",userType:"0",reportType:"1",excelFile:null},[o,k,h]=ce(F),D=X({title:Z().required("Test Title is required")});r.useEffect(()=>{(async()=>{try{let s=await re();$(s||[])}catch(s){console.error(`Error fetching ${x}:`,s),n.fire({icon:"error",title:A(s)||`Failed to load ${x}`,text:"Please try again later"})}})()},[]),r.useEffect(()=>{h&&o&&b.current?.setFieldValue("courseId",o)},[h,o]),r.useEffect(()=>{(async()=>{if(o)try{const s=await g.get(`/api/phases/course/${o}`);E(s.data?.data||[])}catch(s){console.error("Error fetching phases:",s),E([])}})()},[o]),r.useEffect(()=>{(async()=>{if(o)try{const s=await g.get(`/api/chapters/course/${o}`);I(s.data?.data||[])}catch(s){console.error("Error fetching chapters:",s),I([])}})()},[o]),r.useEffect(()=>{(async()=>{if(o)try{const s=await oe(o);T(s)}catch(s){console.error("Error fetching batches:",s),n.fire({icon:"error",title:A(s)||"Failed to load batches",text:s.message||"Please try again later"}),T([])}})()},[o]);const U=(e,s)=>{const l=e.target.files[0];if(!l)return;N(l.name),s("excelFile",l);const a=new FileReader;a.readAsArrayBuffer(l),a.onload=i=>{const W=new Uint8Array(i.target.result),S=le(W,{type:"array"}),O=S.SheetNames[0],G=S.Sheets[O],p=ie.sheet_to_json(G);if(p.length===0){n.fire({icon:"warning",title:"Empty File",text:"The uploaded file contains no data.",confirmButtonColor:"#f0ad4e"}),d([]);return}let v=!1;p.forEach((Y,z)=>{const B=["question","optionA","optionB","correctAns","marks","chapterName"].filter(H=>!Y[H]);B.length>0&&(v=!0,Q(z+1,B.join(", ")))}),v?(y.current.value="",d([])):(n.fire({icon:"success",title:`${p.length} Questions Found`,text:"All questions are properly formatted.",confirmButtonColor:"#28a745"}),d(p))},a.onerror=()=>{n.fire({icon:"error",title:"File Read Error",text:"Failed to read the Excel file.",confirmButtonColor:"#d33"})}},Q=(e,s)=>{n.fire({icon:"warning",title:`Issue in Question No. ${e}`,text:`Missing fields: ${s}. Please check the Excel file.`,confirmButtonColor:"#d33"})},V=async(e,{setSubmitting:s,resetForm:l})=>{u(!0);try{if(!e.excelFile){n.fire({icon:"warning",title:"No File",text:"Please upload an Excel file to create a test.",confirmButtonColor:"#f0ad4e"}),s(!1),u(!1);return}const a=new FormData;a.append("file",e.excelFile),a.append("title",e.title),a.append("testLevel",e.testLevel),a.append("courseId",e.courseId||""),a.append("chapterId",e.chapterId||""),a.append("batchId",e.batchId||""),a.append("phaseId",e.phaseId||""),a.append("totalMarks",e.totalMarks),a.append("minutes",e.minutes),a.append("seconds",e.seconds),a.append("userType",e.userType),a.append("reportType",e.reportType||""),a.append("passingMarks",e.passingMarks);const i=await g.post("/api/tests/upload-excel",a,{headers:{"Content-Type":"multipart/form-data"}});i.data.success?(n.fire({icon:"success",title:"Test Created!",text:i.data.message||"Test created successfully via Excel upload!",confirmButtonColor:"#28a745"}),l(),N(""),d([]),M?.(),f?.(),ne(q,"test","read")&&R("/manage-test")):n.fire({icon:"warning",title:"Creation Failed",text:i.data.message||"Failed to create test. Please try again.",confirmButtonColor:"#d33"})}catch(a){console.error("Error creating test:",a),n.fire({icon:"error",title:"Creation Failed",text:a.response?.data?.message||"Failed to create test. Please try again.",confirmButtonColor:"#d33"})}finally{s(!1),u(!1)}};return t.jsx(ee,{innerRef:b,initialValues:L,validationSchema:D,onSubmit:V,children:e=>t.jsxs(te,{className:"p-10 bg-white rounded-lg shadow-2xl max-w-5xl mx-auto space-y-6 overflow-hidden border-4 border-[rgba(14,85,200,0.83)]",children:[t.jsx("h2",{className:"text-4xl font-bold text-[rgba(14,85,200,0.83)] text-center mb-6",children:"âž• Add Assessment Test"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsx(c,{label:"Test Title*",name:"title",type:"text",formik:e}),t.jsx(m,{label:"Test Level (optional)",name:"testLevel",options:[{_id:"Beginner",title:"Beginner"},{_id:"Intermediate",title:"Intermediate"},{_id:"Advanced",title:"Advanced"}],formik:e})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsx(m,{label:`${x}*`,name:"courseId",options:F,formik:e,disabled:h,onChange:s=>k(s)}),t.jsx(m,{label:"Batch*",name:"batchId",options:_.map(s=>({_id:s._id,title:s.batchName})),formik:e})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[t.jsx(c,{label:"Total Marks*",name:"totalMarks",type:"number",formik:e}),t.jsx(c,{label:"Passing Marks*",name:"passingMarks",type:"number",formik:e}),t.jsx(c,{label:"Minutes*",name:"minutes",type:"number",formik:e}),t.jsx(c,{label:"Seconds (optional)",name:"seconds",type:"number",formik:e})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsx(P,{label:"Type (optional)",name:"userType",formik:e,options:[{label:"Without Login (Open to all)",value:"0"},{label:"With Login",value:"1"}]}),t.jsx(P,{label:"Report Type (optional)",name:"reportType",formik:e,options:[{label:"Yes",value:"1"},{label:"No",value:"0"}]})]}),t.jsxs("div",{className:"bg-gray-50 border-2 border-dashed border-[rgba(14,85,200,0.3)] rounded-xl p-6 text-center hover:shadow-xl transition-all duration-300",children:[t.jsx("h3",{className:"text-lg font-semibold text-[rgba(14,85,200,0.83)] mb-4",children:"ðŸ“˜ Upload Excel File*"}),t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-center gap-5",children:[t.jsxs("label",{className:"flex items-center justify-center gap-3 bg-gradient-to-r from-[rgba(14,85,200,0.9)] to-[rgba(14,85,200,0.7)] text-white px-6 py-3 rounded-lg cursor-pointer shadow-md hover:shadow-lg hover:scale-105 transition-all",children:[t.jsx(se,{className:"text-xl"}),t.jsx("span",{className:"font-medium",children:"Choose Excel File"}),t.jsx("input",{ref:y,type:"file",accept:".xlsx, .xls",className:"hidden",onChange:s=>U(s,e.setFieldValue)})]}),t.jsxs("a",{href:"/Sample_Test.xlsx",download:!0,className:"flex items-center gap-2 text-[rgba(14,85,200,0.83)] font-medium hover:underline transition-all text-sm md:text-base",children:[t.jsx(ae,{className:"text-lg"}),"Download Sample"]})]}),t.jsx("div",{className:"mt-4 text-sm text-gray-600",children:j?t.jsxs("p",{className:"font-medium",children:["âœ… File Selected:"," ",t.jsx("span",{className:"text-[rgba(14,85,200,0.83)]",children:j})]}):t.jsx("p",{className:"italic text-gray-500",children:"No file selected yet"})}),w.length>0&&t.jsxs("div",{className:"mt-3 text-green-600 font-medium text-sm bg-green-50 border border-green-200 px-4 py-2 rounded-lg inline-block",children:[w.length," questions loaded successfully âœ…"]})]}),t.jsxs("div",{className:"text-center pt-4 border-t border-gray-200",children:[t.jsx("button",{type:"submit",disabled:e.isSubmitting||C,className:"bg-[rgba(14,85,200,0.83)] text-white font-semibold px-8 py-3 rounded-xl shadow-lg hover:bg-[rgba(14,85,200,1)] transition duration-300 disabled:opacity-50",children:e.isSubmitting||C?"Creating Test...":"Create Test"}),t.jsx("button",{type:"button",onClick:f,className:"ml-4 bg-gray-400 text-white font-semibold px-8 py-3 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300",children:"Cancel"})]})]})})};export{fe as default};
