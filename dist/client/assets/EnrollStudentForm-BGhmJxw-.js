import{b as _,r as i,a as $,q as I,al as R,c as L,d as M,j as e,aE as T,I as m,f as A,aG as D,x as V,v as q,C as k,a1 as b,S as f,w as W,p as G}from"./index-BlaCQYdb.js";import{M as S}from"./MultiSelectDropdown-C1q29ZzD.js";import{u as z}from"./usePassword-DK4VtSSf.js";const Q=()=>{const{enrollmentId:n}=_(),[d,y]=i.useState([]),[C,c]=i.useState([]),[v,p]=i.useState(!1),[w,h]=i.useState(null),P=$(),{rolePermissions:E}=I(t=>t.permissions),g=i.useRef(null),{password:j,setPassword:B,generate:F}=z(),[x,O]=i.useState(!1);i.useEffect(()=>{(async()=>{try{const o=await q();y(o)}catch(o){console.error(`Error fetching ${k}:`,o)}})()},[]);const s=R({initialValues:{fullName:"",mobileNo:"",email:"",enrolledCourses:[],enrolledBatches:[]},validationSchema:L({fullName:M().required("Full name is required")}),onSubmit:async(t,{resetForm:o})=>{try{p(!0),t.password=j,t.enrolledBatches=[...t.enrolledBatches,...t.enrolledCourses];const a=new FormData;Object.keys(t).forEach(l=>{l==="enrolledCourses"?a.append(l,t[l]):l==="enrolledBatches"?a.append(l,t[l].join(",")):l==="profilePhotoStudent"?t.profilePhotoStudent&&a.append("profilePhotoStudent",t.profilePhotoStudent):a.append(l,t[l])});let r;n?r=await b.put(`/api/enrollments/${n}`,a,{headers:{"Content-Type":"multipart/form-data"}}):r=await b.post("/api/enrollments/admin/enroll",a,{headers:{"Content-Type":"multipart/form-data"}}),r.data.success?(f.fire("✅ Success",r.data.message,"success").then(()=>{W(E,"enrollment","read")&&P("/enrolled-student-list")}),o(),c([]),h(null),g.current&&(g.current.value="")):f.fire("⚠️ Warning",r.data.message||"Operation failed","warning")}catch(a){console.error(a),f.fire("Warning",a.response?.data?.message||"Please Try Again!","warning")}finally{p(!1)}}}),u=v||s.isSubmitting;return i.useEffect(()=>{if(!n)return;(async()=>{p(!0);try{const o=await b.get(`/api/enrollments/${n}`);if(o.data.success&&o.data.data){const a=o.data.data;s.setValues({fullName:a.fullName||"",mobileNo:a.mobileNo||"",email:a.email||"",designation:a.designation||"",collegeName:a.collegeName||"",enrolledCourses:a.enrolledCourses?.map(l=>l._id)||[],enrolledBatches:a.enrolledBatches?.map(l=>l._id)||[],profilePhotoStudent:null}),a.profilePhotoStudent&&h(G.STUDENT_PHOTO+a.profilePhotoStudent);const r=a.enrolledCourses.flatMap(l=>d.find(U=>U._id===l._id)?.batches||[]);c(r),c(r)}else f.fire("⚠️ Warning",o.data.message||"Enrollment not found","warning")}catch(o){console.error(o),f.fire("⚠️ Error",o.response?.data?.message||"Failed to fetch enrollment","error")}finally{p(!1)}})()},[n,d]),i.useEffect(()=>{const t=s.values.enrolledCourses;if(t.length>0){const o=t.flatMap(r=>d.find(N=>N._id===r)?.batches||[]),a=Array.from(new Map(o.map(r=>[r._id,r])).values());c(a)}else c([])},[s.values.enrolledCourses,d]),e.jsx(T,{value:s,children:e.jsxs("form",{onSubmit:s.handleSubmit,className:"p-10 bg-white rounded-lg shadow-2xl max-w-5xl mx-auto space-y-10 overflow-hidden border-4 border-[rgba(14,85,200,0.83)]",children:[e.jsx("h2",{className:"text-4xl font-bold text-[rgba(14,85,200,0.83)] text-center",children:n?"Update Enrollment":"Enroll Participate"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(m,{label:"Full Name*",name:"fullName",formik:s}),e.jsx(m,{label:"Mobile Number (optional)",name:"mobileNo",type:"tel",formik:s}),e.jsx(m,{label:"Email*",name:"email",type:"email",formik:s}),e.jsx(S,{label:"Training Interested*",name:"enrolledCourses",options:d,formik:s,getOptionValue:t=>t._id,getOptionLabel:t=>t.title}),e.jsx(S,{label:"Select Batches*",name:"enrolledBatches",options:C,formik:s,getOptionValue:t=>t._id,getOptionLabel:t=>`${t.batchName} (${t.mode} - ${t.status})`}),e.jsx(m,{label:"Designation (optional)",name:"designation",formik:s}),e.jsx(m,{label:"Organization Name (optional)",name:"collegeName",formik:s}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Profile Photo (optional)"}),e.jsxs("div",{className:"border border-gray-300 rounded-lg w-full px-4 py-2 mt-1 bg-white flex justify-between items-center cursor-pointer hover:shadow-md transition-all focus-within:ring-2 focus-within:ring-blue-400",onClick:()=>document.getElementById("profilePhotoInput").click(),children:[e.jsx("span",{className:"text-gray-800 truncate w-[90%]",children:s.values.profilePhotoStudent?s.values.profilePhotoStudent.name:"Choose a file"}),e.jsx(A,{className:"text-gray-500"})]}),e.jsx("input",{id:"profilePhotoInput",ref:g,type:"file",accept:"image/*",className:"hidden",onChange:t=>{const o=t.target.files[0];s.setFieldValue("profilePhotoStudent",o),o&&h(URL.createObjectURL(o))}}),s.errors.profilePhotoStudent&&e.jsx("p",{className:"text-red-500 text-sm mt-1 font-medium",children:s.errors.profilePhotoStudent}),(s.values.profilePhotoStudent||w)&&e.jsxs("div",{className:"mt-3 flex items-center gap-3",children:[e.jsx("img",{src:s.values.profilePhotoStudent?URL.createObjectURL(s.values.profilePhotoStudent):w,alt:"Profile Preview",className:"w-20 h-20 rounded-lg object-cover border border-gray-300"}),s.values.profilePhotoStudent&&e.jsx("span",{className:"text-gray-700",children:s.values.profilePhotoStudent.name})]})]}),!n&&e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password*"}),e.jsx("input",{type:x?"text":"password",value:j,onChange:t=>B(t.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400",placeholder:"Password"}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-500",onClick:()=>O(!x),children:x?e.jsx(D,{}):e.jsx(V,{})}),e.jsx("button",{type:"button",onClick:()=>F(6),className:"mt-2 text-sm text-blue-600 hover:underline",children:"Generate Password"}),s.errors.password&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:s.errors.password})]})]}),e.jsxs("div",{className:"pt-4 flex flex-col md:flex-row md:justify-end items-center gap-4",children:[e.jsx("button",{type:"submit",disabled:u,className:`w-full md:w-auto px-10 py-3 rounded-xl shadow-lg text-white font-semibold transition duration-300 ${u?"bg-gray-400 cursor-not-allowed":"bg-[rgba(14,85,200,0.83)] hover:bg-[rgba(14,85,200,1)]"}`,children:u?n?"Updating...":"Enrolling...":n?"Update Enrollment":"Add Participate"}),e.jsx("button",{type:"button",disabled:u,onClick:()=>P("/enrollments/upload-excel"),className:`w-full md:w-auto px-6 py-3 rounded-lg shadow transition font-semibold ${u?"bg-gray-400 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:"Upload Participates via Excel/CSV"})]})]})})};export{Q as default};
