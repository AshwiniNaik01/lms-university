import{a1 as b,b as _,a as I,r,q as D,al as U,c as $,j as n,aE as T,I as v,D as j,C as h,T as V,v as k,a6 as R,p as M,S as c,w as O}from"./index-BlaCQYdb.js";import{g as q}from"./chapters-Dib9kOSx.js";import{P as L}from"./PDFUploadField-CVPV1usj.js";import{u as G}from"./useCourseParam-Cp9FvxYK.js";const W=async i=>(await b.post("/api/assignments/create",i,{headers:{"Content-Type":"multipart/form-data"}})).data,z=async(i,l)=>(await b.put(`/api/assignments/${i}`,l,{headers:{"Content-Type":"multipart/form-data"}})).data,H=async i=>(await b.get(`/api/assignments/${i}`)).data;function ee(){const{assignmentId:i}=_(),l=I(),[d,S]=r.useState([]),[J,x]=r.useState(""),E=D(t=>t.permissions.rolePermissions),[F,y]=r.useState([]),[K,m]=r.useState([]),[f,C]=r.useState(!1),[A,N]=r.useState(""),[u,,P]=G(d);r.useEffect(()=>{(async()=>{try{const a=await k(),e=Array.from(new Map(a.map(o=>[o._id,o])).values());S(e)}catch(a){console.error(`Error fetching ${h}:`,a)}})()},[]),r.useEffect(()=>{u&&d.length>0&&(x(u),s.setFieldValue("course",u))},[u,d]);const s=U({initialValues:{course:"",chapter:"",batches:"",title:"",description:"",deadline:"",fileUrl:null},validationSchema:$({}),onSubmit:async(t,{resetForm:a})=>{try{const e=new FormData;Object.entries(t).forEach(([w,p])=>{w==="batches"?e.append("batches",p):p&&e.append(w,p)});let o;if(i?(o=await z(i,e),c.fire({icon:"success",title:o.message||"Assignment updated successfully!",showConfirmButton:!0})):(o=await W(e),c.fire({icon:"success",title:o.message||"Assignment created successfully!",showConfirmButton:!0})),!O(E,"assignment","read")){c.fire({icon:"warning",title:"Assignment created successfully, but you don't have permission to view assignments."}),a();return}a(),l("/manage-assignments")}catch(e){c.fire({icon:"error",title:"Submission failed!",text:e.response?.data?.message||e.message||"Please Try Again!"})}}});r.useEffect(()=>{(async()=>{const a=s.values.course;if(!a){y([]);return}const e=await R(a);y(e)})()},[s.values.course]),r.useEffect(()=>{(async()=>{const a=s.values.course;if(!a){m([]);return}try{const e=await q(a),o=Array.from(new Map(e.data.map(g=>[g._id,g])).values());m(o)}catch(e){console.error(`Error fetching chapters for ${h}:`,e),m([])}})()},[s.values.course]),r.useEffect(()=>{if(!i)return;(async()=>{C(!0);try{const a=await H(i);if(a.success&&a.data){const e=a.data;s.setValues({course:e.chapter?.course?._id||e.course?._id||"",chapter:e.chapter?._id||"",batches:e.batches||[],title:e.title||"",description:e.description||"",deadline:e.deadline?.split("T")[0]||"",fileUrl:null}),e.fileUrl&&N(M.ASSIGNMENT_FILES+e.fileUrl)}else c.fire({icon:"warning",title:"Oops...",text:a.message||"Assignment not found",confirmButtonColor:"#0E55C8"}),l("/manage-assignments")}catch(a){console.error(a),c.fire({icon:"warning",title:"Warning!",text:a.response?.data?.message||"Failed to fetch assignment",confirmButtonColor:"#0E55C8"}),l("/manage-assignments")}finally{C(!1)}})()},[i]);const B=d.map(t=>({_id:t._id,title:t.title}));return f?n.jsx("p",{className:"text-center mt-10",children:"Loading assignment..."}):n.jsx(T,{value:s,children:n.jsxs("form",{onSubmit:s.handleSubmit,className:"p-8 bg-white rounded-lg shadow-lg max-w-5xl mx-auto space-y-6 border-4 border-[rgba(14,85,200,0.83)]",children:[n.jsx("h2",{className:"text-3xl font-bold mb-6 text-blue-700 text-center underline",children:i?"Edit Assignment":"Add Assignment"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n.jsx(v,{label:"Title*",name:"title",type:"text",formik:s}),n.jsx(v,{label:"Deadline*",name:"deadline",type:"date",formik:s}),n.jsx(j,{label:`${h}*`,name:"course",options:B,formik:s,value:s.values.course,onChange:t=>{s.setFieldValue("course",t),x(t)},disabled:P}),n.jsx(j,{label:"Batch*",name:"batches",formik:s,options:F.map(t=>({_id:t._id,title:`${t.batchName} (${t.mode} - ${t.status})`})),onChange:t=>{s.setFieldValue("batches",t)}}),n.jsxs("div",{className:"flex flex-col",children:[n.jsx(L,{label:"Assignment File (PDF)*",name:"fileUrl",formik:s}),A&&n.jsx("a",{href:A,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline mb-2 block",children:"View Existing File"})]}),n.jsx("div",{className:"flex flex-col md:col-span-2",children:n.jsx(V,{label:"Description (optional)",name:"description",formik:s,rows:5})})]}),n.jsxs("div",{className:"text-center mt-4 flex justify-end gap-4",children:[n.jsx("button",{type:"button",onClick:()=>s.resetForm(),className:"bg-gray-400 text-white px-8 py-3 rounded-lg hover:bg-gray-500 transition font-semibold",children:"Cancel"}),n.jsx("button",{type:"submit",disabled:s.isSubmitting||f,className:"bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold disabled:opacity-50",children:s.isSubmitting||f?i?"Updating...":"Creating...":i?"Update Assignment":"Add Assignment"})]})]})})}export{ee as default};
