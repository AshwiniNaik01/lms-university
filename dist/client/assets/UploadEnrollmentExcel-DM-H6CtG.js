import{r as c,j as e,a0 as T,a2 as M,a3 as w,a4 as U,v as D,S as i,C as f,a1 as O}from"./index-BlaCQYdb.js";import{r as L,u as z}from"./xlsx-uZelXSz_.js";import{u as q}from"./usePassword-DK4VtSSf.js";const J=()=>{const[d,x]=c.useState([]),[u,h]=c.useState(null),m=c.useRef(null),[g,C]=c.useState([]),[b,S]=c.useState(""),[y,B]=c.useState(""),[E,I]=c.useState(""),[H,F]=c.useState(""),{generate:$}=q();c.useEffect(()=>{const o=new URLSearchParams(location.search),r=o.get("batchId"),t=o.get("courseIds");(async()=>{const a=await D();if(C(a),t){const l=a.find(n=>n._id===t.split(",")[0]);l&&(S(l._id),I(l.title))}if(r){const l=a.flatMap(n=>n.batches).find(n=>n._id===r);l&&(B(l._id),F(l.batchName))}})()},[location.search]);const P=o=>{const r=o.target.files[0];if(!r)return;h(r);const t=new FileReader;t.readAsArrayBuffer(r),t.onload=s=>{const a=new Uint8Array(s.target.result),l=L(a,{type:"array"}),n=l.Sheets[l.SheetNames[0]],j=z.sheet_to_json(n);if(j.length===0){i.fire({icon:"warning",title:"Empty File",text:"The uploaded file contains no data.",confirmButtonColor:"#f0ad4e"}),x([]);return}const _=["fullName","mobileNo","email"];let v=!1;j.forEach((p,A)=>{const N=_.filter(R=>!p[R]);N.length>0&&(v=!0,i.fire({icon:"warning",title:`Row ${A+2} Missing Fields`,text:`Missing: ${N.join(", ")}`,confirmButtonColor:"#d33"})),(!p.password||p.password.toString().trim()==="")&&(p.password=$(8))}),v?(x([]),m.current.value=""):x(j)},t.onerror=()=>{i.fire({icon:"error",title:"File Read Error",text:"Failed to read the Excel file.",confirmButtonColor:"#d33"})}},k=async()=>{if(!d||d.length===0)return i.fire("Error","No data to import","error");let o=b,r=y;if(!o||!r){const{value:t}=await i.fire({title:`<strong>Assign ${f} & Batch</strong>`,html:`
          <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
            <div style="display: flex; flex-direction: column; text-align: left;">
              <label for="trainingProgram" style="font-weight: 600; margin-bottom: 5px; color: #4a5568;">${f}</label>
              <select id="trainingProgram" class="swal2-select" style="border-radius: 8px; padding: 10px; border: 1px solid #cbd5e0; font-size: 14px;">
                <option value="">Select ${f}</option>
                ${g.map(s=>`<option value="${s._id}">${s.title}</option>`).join("")}
              </select>
            </div>
            <div style="display: flex; flex-direction: column; text-align: left;">
              <label for="batch" style="font-weight: 600; margin-bottom: 5px; color: #4a5568;">Batch</label>
              <select id="batch" class="swal2-select" style="border-radius: 8px; padding: 10px; border: 1px solid #cbd5e0; font-size: 14px;">
                <option value="">Select Batch</option>
              </select>
            </div>
          </div>
        `,didOpen:()=>{const s=i.getPopup().querySelector("#trainingProgram"),a=i.getPopup().querySelector("#batch");s.addEventListener("change",()=>{const l=g.find(n=>n._id===s.value);if(a.innerHTML='<option value="">Select Batch</option>',!l||!l.batches?.length){a.innerHTML='<option value="">No batches available</option>';return}a.innerHTML+=l.batches.map(n=>`<option value="${n._id}">${n.batchName}</option>`).join("")})},focusConfirm:!1,showCancelButton:!0,confirmButtonText:"✅ Assign",cancelButtonText:"❌ Cancel",preConfirm:()=>{const s=document.getElementById("trainingProgram").value,a=document.getElementById("batch").value;return(!s||!a)&&i.showValidationMessage(`Please select both ${f} and Batch`),{trainingProgramId:s,batchId:a}}});if(!t)return;o=t.trainingProgramId,r=t.batchId}try{const t=await O.post("/api/enrollments/upload",{excelData:d,enrolledCourses:o,enrolledBatches:r});if(t.data.success){const{skippedStudents:s=[]}=t.data.data||{};s.length?i.fire({icon:"success",title:"Import Completed",text:t.data.message,html:s.length?`
        <hr style="margin: 10px 0; border-color:#ddd;"/>
        <p style="margin-bottom:10px;">
          The following students are already assigned to the selected training program and batch:
        </p>
        <div style="text-align:left; max-height:200px; overflow:auto;">
          <ul style="padding-left:18px;">
            ${s.map(a=>`<li style="margin-bottom:6px;">
                    <strong>${a.fullName}</strong><br/>
                    <span style="color:#555;font-size:13px;">${a.email}</span>
                  </li>`).join("")}
          </ul>
        </div>
      `:null,confirmButtonText:"OK"}):i.fire({icon:"success",title:"Import Successful",text:t.data.message,confirmButtonText:"OK"}),x([]),h(null),m.current&&(m.current.value="")}}catch(t){i.fire("Error",t.response?.data?.message||"Upload failed","error")}};return e.jsx("div",{className:"max-h-screen",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("div",{className:"bg-white rounded-xl shadow border border-gray-200 p-4 mb-2",children:e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:e.jsx("h4",{className:"text-2xl lg:text-3xl font-bold text-gray-900 mb-2",children:b&&y?`Add Participate for ${E} - ${g.find(t=>t._id===b)?.batches?.find(t=>t._id===y)?.batchName||"N/A"}`:"Add Participate"})})}),e.jsx("div",{className:"",children:e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Upload Excel File"}),e.jsxs("a",{href:"/Enrollment_Sample.xlsx",download:!0,className:"w-75 flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium shadow-sm",children:[e.jsx(T,{className:"w-5 h-5"}),"Download Sample Excel"]})]}),d.length===0&&e.jsxs("div",{className:`border-2 border-dashed rounded-xl p-4 text-center transition-all duration-300 \r
                cursor-pointer border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50`,onClick:()=>m.current?.click(),children:[e.jsx("input",{ref:m,type:"file",accept:".xlsx, .xls",onChange:P,className:"hidden"}),e.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(M,{className:"text-blue-600 w-8 h-8"})}),u?e.jsxs("div",{children:[e.jsxs("p",{className:"text-green-600 font-semibold mb-2",children:["File Selected ",e.jsx(w,{className:"inline"})]}),e.jsx("p",{className:"text-gray-600 text-sm",children:u.name}),e.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:[(u.size/1024/1024).toFixed(2)," MB"]})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-700 font-medium mb-2",children:"Click to upload or drag and drop"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Excel files only (.xlsx, .xls)"})]})]})]}),d.length>0&&e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:"Data Preview"}),e.jsxs("div",{className:"flex items-center justify-between gap-6",children:[e.jsx("div",{className:"bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium",children:"Ready to Import"}),u&&e.jsxs("button",{onClick:()=>{x([]),h(null),m.current.value=""},className:`flex items-center gap-2 px-4 py-2 border border-red-300 text-red-600 \r
                        bg-red-50 hover:bg-red-100 rounded-lg transition-all duration-200 font-medium shadow-sm`,children:[e.jsx(U,{className:"w-4 h-4"}),"Remove File"]})]})]}),e.jsx("div",{className:"border rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-auto max-h-96",children:e.jsxs("table",{className:"w-full min-w-full",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[Object.keys(d[0]).map((o,r)=>e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b",children:o},r)),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase border-b",children:"Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:d.map((o,r)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[Object.values(o).map((t,s)=>e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 border-b",children:t||e.jsx("span",{className:"text-gray-400 italic",children:"empty"})},s)),e.jsx("td",{className:"px-4 py-3 border-b text-center",children:e.jsx("button",{className:"text-red-600 hover:text-red-800",onClick:()=>{const t=d.filter((s,a)=>a!==r);x(t)},children:"❌"})})]},r))})]})})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-end mt-6 pt-6 border-t border-gray-200",children:[e.jsx("button",{className:"px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-medium flex-1 sm:flex-none",onClick:()=>{x([]),h(null),m.current.value=""},children:"Cancel Upload"}),e.jsxs("button",{className:"px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium shadow-sm flex items-center justify-center gap-2 flex-1 sm:flex-none",onClick:k,children:[e.jsx(w,{className:"w-5 h-5"}),"Import ",d.length," Participates"]})]})]})]})})]})})};export{J as default};
