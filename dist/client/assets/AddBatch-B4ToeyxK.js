import{r as u,j as e,a0 as J,a2 as z,a3 as Y,S as i,b as G,a as K,q as Q,w as X,I as M,D as I,C as V,p as Z,T as ee,a1 as U,c5 as ae,c6 as se,v as te,c7 as le,a5 as re}from"./index-BlaCQYdb.js";import{f as ne}from"./trainerApi-C8uD07iT.js";import{r as de,u as ie}from"./xlsx-uZelXSz_.js";import{u as oe}from"./useCourseParam-Cp9FvxYK.js";import{u as ce}from"./usePassword-DK4VtSSf.js";const ue=({sampleFileUrl:O,requiredFields:m=["fullName","mobileNo","email"],onImport:p,title:b="Upload Excel File"})=>{const[j,f]=u.useState([]),[F,A]=u.useState(null),g=u.useRef(null),v=c=>{const d=c.target.files[0];if(!d)return;A(d);const h=new FileReader;h.readAsArrayBuffer(d),h.onload=y=>{const k=new Uint8Array(y.target.result),E=de(k,{type:"array"}),t=E.Sheets[E.SheetNames[0]],r=ie.sheet_to_json(t);if(r.length===0){i.fire({icon:"warning",title:"Empty File",text:"The uploaded file contains no data."}),f([]);return}let C=!1;if(r.forEach((P,L)=>{const T=m.filter(w=>!P[w]);T.length>0&&(C=!0,i.fire({icon:"warning",title:`Row ${L+2} Missing Fields`,text:`Missing: ${T.join(", ")}`}))}),C){f([]),g.current.value="";return}i.fire({icon:"success",title:`${r.length} Participates Found`,text:"Excel file is properly formatted."}),f(r),p&&p({file:d,data:r})},h.onerror=()=>{i.fire({icon:"error",title:"File Read Error",text:"Failed to read the Excel file."})}},D=()=>{f([]),A(null),g.current&&(g.current.value="")};return e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:b}),O&&e.jsxs("a",{href:O,download:!0,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:[e.jsx(J,{className:"w-5 h-5"}),"Sample Excel"]})]}),j.length===0&&e.jsxs("div",{className:"border-2 border-dashed rounded-xl p-4 text-center cursor-pointer bg-gray-50 hover:border-blue-400 hover:bg-blue-50",onClick:()=>g.current?.click(),onDragOver:c=>c.preventDefault(),onDrop:c=>{c.preventDefault();const d=c.dataTransfer.files[0];d&&v({target:{files:[d]}})},children:[e.jsx("input",{ref:g,type:"file",accept:".xlsx, .xls",onChange:v,className:"hidden"}),e.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(z,{className:"text-blue-600 w-8 h-8"})}),F?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-green-600 font-semibold mb-2",children:["File Selected ",e.jsx(Y,{className:"inline"})]}),e.jsx("p",{className:"text-gray-600 text-sm",children:F.name}),e.jsxs("p",{className:"text-gray-500 text-xs mt-1",children:[(F.size/1024/1024).toFixed(2)," MB"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-700 font-medium mb-2",children:"Click to upload or drag & drop"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Excel files only"})]})]}),j.length>0&&e.jsxs("div",{className:"mt-6 border rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"overflow-auto max-h-96",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[Object.keys(j[0]).map((c,d)=>e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 border-b",children:c},d)),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-700 border-b",children:"Action"})]})}),e.jsx("tbody",{children:j.map((c,d)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[Object.values(c).map((h,y)=>e.jsx("td",{className:"px-4 py-3 text-sm",children:h||e.jsx("span",{className:"text-gray-400 italic",children:"empty"})},y)),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("button",{className:"text-red-600 hover:text-red-800",onClick:()=>f(h=>h.filter((y,k)=>k!==d)),children:"âŒ"})})]},d))})]})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx("button",{className:"px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600",onClick:D,children:"Cancel Upload"})})]})]})},fe=({onBatchSaved:O})=>{const{id:m}=G(),p=K(),[b,j]=u.useState(m||null),[f,F]=u.useState([]),[A,g]=u.useState([]),[v,D]=u.useState(!1),{rolePermissions:c}=Q(a=>a.permissions),[d,h]=u.useState(null),[y,k]=u.useState([]),{generate:E}=ce(),[t,r]=u.useState({batchName:"",time:{start:"",end:""},days:[],mode:"Online",startDate:"",endDate:"",coursesAssigned:"",trainer:[],additionalNotes:"",durationPerDayHours:"",cloudLabsOption:"no",cloudLabs:{link:"",excelFile:null},labs:null}),C=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],P=[{_id:"Online",title:"Online"},{_id:"Offline",title:"Offline"},{_id:"Hybrid",title:"Hybrid"}],[L,T,w]=oe(f),_=()=>{r({batchName:"",time:{start:"",end:""},days:[],mode:"Online",startDate:"",endDate:"",coursesAssigned:"",trainer:[],additionalNotes:"",durationPerDayHours:"",cloudLabsLink:"",labs:null,cloudLabsOption:"no"}),h(null),k([]),j(null)},W=A.map(a=>({...a,title:a.fullName}));u.useEffect(()=>{(async()=>{const s=await H();s?.data&&g(s.data),m?await $():w&&r(l=>({...l,coursesAssigned:L}))})()},[m,L,w]);const H=async()=>{try{const[a,s]=await Promise.all([te(),ne()]);F(a||[]),g(s||[])}catch(a){i.fire({icon:"warning",title:"Warning",text:a.response?.data?.message||`Failed to fetch ${V} or Trainers.`})}},$=async()=>{if(m)try{D(!0);const a=await le(m),s=!!a.cloudLabs?.link||!!a.cloudLabs?.cloudLabsFile?.fileUrl;a?(r({batchName:a.batchName||"",time:{start:a.time?.start||"",end:a.time?.end||""},days:a.days||[],mode:a.mode||"Online",startDate:a.startDate||"",endDate:a.endDate||"",coursesAssigned:a.coursesAssigned?.[0]?._id||"",trainer:a.trainer?.map(l=>l._id)||[],additionalNotes:a.additionalNotes||"",durationPerDayHours:a.durationPerDayHours||"",cloudLabsOption:s?"yes":"no",cloudLabs:s?{link:a.cloudLabs?.link||"",cloudLabsFile:a.cloudLabs?.cloudLabsFile||null}:{link:"",cloudLabsFile:null},labs:null}),j(m)):(i.fire("Not Found","Batch not found","warning"),p("/manage-batches"))}catch(a){i.fire("Error",re(a)||"Failed to fetch batch.","error"),p("/manage-batches")}finally{D(!1)}};u.useEffect(()=>{(async()=>{await H(),m?await $():w&&r(s=>({...s,coursesAssigned:L}))})()},[m,L,w]);const R=a=>{const{name:s,value:l,type:o,checked:N}=a.target;o==="checkbox"&&C.includes(l)?r(x=>({...x,days:N?[...x.days,l]:x.days.filter(S=>S!==l)})):r(x=>({...x,[s]:l}))},q=async a=>{a.preventDefault(),D(!0);try{const s={batchName:t.batchName,time:t.time||{start:"",end:""},days:t.days,mode:t.mode,startDate:t.startDate,endDate:t.endDate,coursesAssigned:t.coursesAssigned?[t.coursesAssigned]:[],trainer:t.trainer,additionalNotes:t.additionalNotes,durationPerDayHours:t.durationPerDayHours};let l=b,o;const N=!!b,x=!!t.labs,S=t.cloudLabsOption==="yes"&&t.cloudLabs.link?.trim();if(x||S){const n=new FormData;if(n.append("batchName",s.batchName),n.append("time[start]",s.time.start),n.append("time[end]",s.time.end),s.days.forEach(B=>n.append("days[]",B)),n.append("mode",s.mode),n.append("startDate",s.startDate),n.append("endDate",s.endDate),n.append("durationPerDayHours",s.durationPerDayHours??""),n.append("additionalNotes",s.additionalNotes??""),s.coursesAssigned.forEach(B=>n.append("coursesAssigned[]",B)),s.trainer.forEach(B=>n.append("trainer[]",B)),S&&n.append("cloudLabsLink",t.cloudLabs.link),x&&n.append("labs",t.labs),N)await U.put(`/api/batches/${b}`,n,{headers:{"Content-Type":"multipart/form-data"}}),l=b,i.fire("Updated!","Batch updated successfully.","success");else{if(o=await U.post("/api/batches",n,{headers:{"Content-Type":"multipart/form-data"}}),l=o?.data?.batch?._id||o?.data?.data?.batchId,!l)throw new Error("Batch ID not returned from API.");i.fire("Added!","Batch added successfully.","success")}}else if(N)await ae(b,s),l=b,i.fire("Updated!","Batch updated successfully.","success").then(()=>{p("/manage-batches")});else{if(o=await se(s),l=o?.data?.batch?._id||o?.data?.data?.batchId,!l)throw new Error("Batch ID not returned from API.");i.fire("Added!","Batch added successfully.","success")}if(d&&l){const n=new FormData;n.append("excelFile",d),n.append("enrolledCourses",JSON.stringify(s.coursesAssigned)),n.append("enrolledBatches",JSON.stringify([l])),await U.post("/api/batches/upload-excel",n,{headers:{"Content-Type":"multipart/form-data"}}),i.fire("Success","Excel file uploaded successfully!","success")}if(!N){const n=await i.fire({title:"Batch saved successfully! What would you like to do next?",showDenyButton:!0,showCancelButton:!0,confirmButtonText:"Add New Batch",denyButtonText:"Show List",cancelButtonText:"Add Participant"});n.isConfirmed?_():n.isDenied?p(`/manage-batches?courseId=${t.coursesAssigned||""}`):n.isDismissed&&l&&p(`/enrollments/upload-excel?batchId=${l}&courseIds=${t.coursesAssigned}`)}_()}catch(s){i.fire("Error",s?.response?.data?.message||s?.message||"Failed to save batch. Please try again.","error")}finally{D(!1)}};return e.jsx("div",{className:"p-10 bg-blue-50 min-h-screen",children:e.jsxs("div",{className:"bg-white p-10 rounded-xl shadow-xl max-w-5xl mx-auto border-4 border-blue-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("h3",{className:"text-3xl font-bold text-blue-700 underline",children:b?"Update Batch":"Create Batch"}),X(c,"batch","read")&&e.jsx("button",{onClick:()=>p("/manage-batches"),className:"text-md bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md font-bold text-white transition",children:"â† Manage Batches"})]}),e.jsxs("form",{onSubmit:q,className:"space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(M,{label:"Batch Name*",name:"batchName",type:"text",formik:{values:t,setFieldValue:(a,s)=>r(l=>({...l,[a]:s})),touched:{},errors:{},handleBlur:()=>{}}}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Duration (Hours Per Day)*"}),e.jsx("input",{type:"number",min:"0.5",step:"any",placeholder:"e.g. 2, 2.5, 2.8",value:t.durationPerDayHours,onChange:a=>r(s=>({...s,durationPerDayHours:a.target.value})),className:"w-full border-2 border-blue-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Start Date*"}),e.jsx("input",{type:"date",value:t.startDate,onChange:a=>r(s=>({...s,startDate:a.target.value})),className:"w-full border-2 border-blue-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"End Date*"}),e.jsx("input",{type:"date",value:t.endDate,onChange:a=>r(s=>({...s,endDate:a.target.value})),className:"w-full border-2 border-blue-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"Start Time*"}),e.jsx("input",{type:"time",value:t.time?.start||"",onChange:a=>r(s=>({...s,time:{...s.time,start:a.target.value}})),className:"w-full border-2 border-blue-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"End Time*"}),e.jsx("input",{type:"time",value:t.time?.end||"",onChange:a=>r(s=>({...s,time:{...s.time,end:a.target.value}})),className:"w-full border-2 border-blue-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx(I,{label:"Mode*",name:"mode",options:P,formik:{values:t,setFieldValue:(a,s)=>r(l=>({...l,[a]:s})),touched:{},errors:{},handleBlur:()=>{}}}),e.jsx(I,{label:`Assign ${V}*`,name:"coursesAssigned",options:f,formik:{values:t,setFieldValue:(a,s)=>r(l=>({...l,[a]:s})),handleBlur:()=>{},touched:{},errors:{}},disabled:w}),e.jsx(I,{label:"Assign Trainer*",name:"trainer",options:W,formik:{values:t,setFieldValue:(a,s)=>r(l=>({...l,[a]:[s]})),handleBlur:()=>{},touched:{},errors:{}},getOptionValue:a=>a._id,getOptionLabel:a=>a.fullName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"font-semibold text-gray-700 mb-2 block",children:"Days:*"}),e.jsx("div",{className:"flex flex-wrap gap-3 mt-1",children:C.map(a=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer bg-blue-100 px-4 py-2 rounded-lg hover:bg-blue-200",children:[e.jsx("input",{type:"checkbox",value:a,checked:t.days.includes(a),onChange:R,className:"accent-blue-700 w-5 h-5"}),a]},a))})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 mb-6",children:[e.jsx("label",{className:"font-semibold text-gray-700 mb-2 block",children:"Do you want to provide CloudLabs access?"}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"cloudLabsOption",value:"yes",checked:t.cloudLabsOption==="yes",onChange:()=>r(a=>({...a,cloudLabsOption:"yes"})),className:"accent-blue-600"}),"Yes"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"cloudLabsOption",value:"no",checked:t.cloudLabsOption==="no",onChange:()=>r(a=>({...a,cloudLabsOption:"no",cloudLabs:{link:"",excelFile:null},labs:null}))}),"No"]})]})]}),e.jsx("a",{href:"/cloudlabs_sample_excel.xlsx",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm mt-2 inline-block",children:"Download sample Excel"}),t.cloudLabsOption==="yes"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(M,{label:"CloudLabs Link",name:"cloudLabs.link",type:"url",placeholder:"https://cloudlabs.example.com",formik:{values:{cloudLabs:t.cloudLabs},setFieldValue:(a,s)=>r(l=>({...l,cloudLabs:{...l.cloudLabs,link:s}})),touched:{},errors:{},handleBlur:()=>{}}}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"CloudLabs Excel"}),t.cloudLabs?.cloudLabsFile&&e.jsxs("a",{href:Z.CLOUD_LABS+t.cloudLabs.cloudLabsFile.fileName,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline text-sm mb-2 block",children:["ðŸ“„ ",t.cloudLabs.cloudLabsFile.fileName]}),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:a=>r(s=>({...s,labs:a.target.files[0]})),className:"w-full border-2 border-dashed border-gray-300 p-2 rounded-lg"})]})]}),e.jsx(ee,{label:"Additional Notes (optional)",name:"additionalNotes",formik:{values:t,handleChange:R,handleBlur:()=>{},touched:{},errors:{}},rows:4}),e.jsx(ue,{sampleFileUrl:"/Enrollment_Sample.xlsx",requiredFields:["fullName","mobileNo","email"],title:"Upload Participate Excel (optional)",onImport:({file:a,data:s})=>{const l=s.map(o=>{const N=o.password??"",x=N.toString().trim()==="";return{...o,password:x?E(8):N.toString()}});h(a),k(l)}},d?d.name:"excel-uploader"),y.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"font-semibold text-gray-700 mb-2",children:"Excel Preview:"}),e.jsx("div",{className:"overflow-x-auto border rounded-lg",children:e.jsxs("table",{className:"min-w-full text-left border-collapse",children:[e.jsx("thead",{className:"bg-blue-100",children:e.jsx("tr",{children:Object.keys(y[0]).map(a=>e.jsx("th",{className:"px-4 py-2 border-b border-gray-300 text-gray-700 font-medium",children:a},a))})}),e.jsx("tbody",{children:y.map((a,s)=>e.jsx("tr",{className:s%2===0?"bg-white":"bg-blue-50",children:Object.values(a).map((l,o)=>e.jsx("td",{className:"px-4 py-2 border-b border-gray-200 text-gray-600",children:l||e.jsx("span",{className:"text-gray-400 italic",children:"empty"})},o))},s))})]})})]}),e.jsxs("div",{className:"text-center flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:_,disabled:v,className:"bg-gray-300 text-gray-800 font-semibold px-10 py-3 rounded-xl shadow-lg hover:bg-gray-400 disabled:opacity-60",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:v,className:"bg-blue-600 text-white font-semibold px-10 py-3 rounded-xl shadow-lg hover:bg-blue-700 disabled:opacity-60",children:v?"Saving...":b?"Update Batch":"Create Batch"})]})]})]})})};export{fe as default};
